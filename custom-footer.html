<div class="container">
  <!-- update link to point to your own statement -->
  <p><a href="https://www.notifications.service.gov.uk/accessibility-statement">Accessibility statement</a></p>
</div>
<script>
$(function() {
  // add skiplink and link to main content
  var pathRoot = "/" + window.location.pathname.split('/')[1];
  var mainContainerMap = {
    "/" : ".masthead-container + .container",
    "/history": ".months-container",
    "/incidents": ".incident-updates-container"
  };

  // Add skiplink
  if (mainContainerMap.hasOwnProperty(pathRoot)) {
    document.querySelector(mainContainerMap[pathRoot]).setAttribute('id', 'main-content');
    document.body.insertAdjacentHTML('afterbegin', '<a href="#main-content" class="govuk-skip-link">Skip to main content</a>'); 
  }

  $('.components-container').removeClass('two-columns').addClass('one-column');
  // adds autocomplete attributes to controls that don't have one
  var selectorAndAutocompleteAttributes = {
    email: "email",
    phone_country: "tel-country-code",
    phone_number: "tel-national"
  }

  $.each(selectorAndAutocompleteAttributes, function(key, val) {
    var $targetElements = $(`[name='${key}']`);
    $.each($targetElements, function() {
      $(this).attr('autocomplete', val);
    });
  });

  // a11y fixes for subscribe to ongoing incident(s) button
  $('.subscribe-button').attr('aria-haspopup', 'dialog').text(function() {
    return this.text + ' for this incident';
  });

  function removeExpandIncidents () {
    // expand / show all incidents in a given month
    $('.expand-incidents').click().remove()
  }
  
  removeExpandIncidents();

  var $logo = document.querySelector('.page-name');
  var $container = document.querySelector('.layout-content > .container');
  var $pageFooter = document.querySelector('.page-footer');

  function swapElForHTML ($oldEl, newHTML) {
    $oldEl.insertAdjacentHTML('beforebegin', newHTML);
    $oldEl.remove();
  }

  function reformatDateRanges () {
    function reformatRange ($range) {
      if (/^[A-Za-z-]+\s+\d+,\s+\d+:\d+\s+-\s+([A-Za-z]+\s+\d+,\s+)?\d+:\d+\s+[A-Z]+$/.test($range.textContent)) {
        var $dateVars = $range.querySelectorAll('var[data-var=date]');

        $range.insertAdjacentElement('afterbegin', $dateVars[0]);
        $range.childNodes[1].nodeValue = ' ' + $range.childNodes[1].nodeValue.trim();
        if ($dateVars.length > 1) {
          var $month = $dateVars[1].previousSibling;
          $range.insertBefore($dateVars[1], $month);
          $month.nodeValue = $month.nodeValue.replace(' - ', ' ');
          $range.insertBefore(document.createTextNode(' - '), $dateVars[1]);
        }
      }
    }

    if (document.querySelector('.incident-list') !== null) {
      var $incidentDateRanges = document.querySelectorAll('.incident-data > .secondary');

      if ($incidentDateRanges !== null) { $incidentDateRanges.forEach($el => reformatRange($el)); }
    }
  }

  function makeSentenceCase (str) {
    var trimmed = str.trim();
    return trimmed[0].toUpperCase() + trimmed.slice(1).toLowerCase();
  }

  function getNodeByXPath (xpath) {
    var result = document.evaluate(
      xpath,
      document,
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null,
    );

    return result.singleNodeValue;
  }

  // Rewrite logo
  if ($logo !== null) {
     $logo.querySelector('a').textContent = 'GOV.UK Notify';
  }

  // Add heading to footer
  if ($pageFooter !== null) {
    $pageFooter.insertAdjacentHTML('afterbegin', '<h2 class="page-footer__heading govuk-visually-hidden">Support links</h2>');
    var $footerLinkText = getNodeByXPath("//div[contains(@class, 'page-footer')]/a/text()");

    if ($footerLinkText !== null) {
      $footerLinkText.nodeValue = ' ' + makeSentenceCase($footerLinkText.nodeValue);
    }
  }

  if ($container !== null) {

    reformatDateRanges();

    // Home page specific
    if (pathRoot === "/") {
      var $aboutText = document.querySelector('.page-status + .text-section');
      var $pageStatus = document.querySelector('.page-status');
      var $pageStatusContent = $pageStatus.querySelector('h2');

      if (($aboutText !== null) && ($pageStatus !== null) && ($pageStatusContent !== null)) {
        // Add headings and move 'about' text
        $container.insertAdjacentElement('afterbegin', $aboutText);
        $container.insertAdjacentHTML('afterbegin', '<h1 class="font-x-largest">GOV.UK Notify status page</h1>');
        $pageStatus.insertAdjacentHTML('beforebegin', '<h2 class="page-status__heading font-largest">Current status</h2>');

        // Remake status overview from h2 to p
        swapElForHTML($pageStatusContent, `<p class="${$pageStatusContent.className}">${$pageStatusContent.textContent}</p>`);

        // Rewrite heading for incidents list to make it clear it includes today
        document.querySelector('.incidents-list > h2:first-child').textContent = "Recent incidents";

        // Reformat dates
        document.querySelectorAll('.status-day > .date').forEach($el => {
          if (/^[A-Za-z]+\s+\d{1,2},\s+\d{4}$/.test($el.textContent)) {
            $textNodes = Array.from($el.childNodes).filter($el => $el.nodeType === 3);
            $el.insertAdjacentElement('afterbegin', $el.querySelector('var:first-of-type'));
            $textNodes[0].nodeValue = " " + $textNodes[0].nodeValue;
            $textNodes[1].remove();
          }
        });
      }
    }

    if (pathRoot === "/history") {
      var $pageHeading = $container.querySelector('h4:first-child');
      var $incidentsList = $container.querySelector('.months-container');

      if ($pageHeading !== null) {
        swapElForHTML($pageHeading, `<h1 class="font-x-largest">${makeSentenceCase($pageHeading.textContent)}</h1>`);
      }

      function updateIncidentsListHeadings () {
        var $monthHeadings = $incidentsList.querySelectorAll('h4.month-title');

        if ($monthHeadings.length > 0) {
          $monthHeadings.forEach($el => swapElForHTML($el, `<h2 class="${$el.className}">${$el.textContent}</h2>`));
        }
      }

      updateIncidentsList();

      var observer = new MutationObserver(() => {
        updateIncidentsListHeadings()
        reformatDateRanges();
        removeExpandIncidents()
      });
      observer.observe($incidentsList, { attributes: true, childList: true, subtree: true });
    }

    if (pathRoot === "/incidents") {
      var $pageHeadingContextPrefix = getNodeByXPath("//h1/following-sibling::div[contains(@class, 'subheader')]/text()");
      var $affectedHeading = $container.querySelector('.components-affected');

      if ($pageHeadingContextPrefix !== null) {
        $pageHeadingContextPrefix.nodeValue = makeSentenceCase($pageHeadingContextPrefix.nodeValue) + ' ';
      }

      if ($affectedHeading !== null) {
        $affectedHeading.insertAdjacentHTML(
          'afterbegin', '<h2 class="govuk-visually-hidden">Components affected</h2>'
        );
      }
    }

  }
});
</script>
